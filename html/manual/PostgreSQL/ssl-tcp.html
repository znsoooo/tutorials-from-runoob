<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>18.9. 用 SSL 进行安全的 TCP/IP 连接</title><link rel="stylesheet" type="text/css" href="../../0/stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="prev" href="encryption-options.html" title="18.8. 加密选项" /><link rel="next" href="ssh-tunnels.html" title="18.10. 使用SSH隧道的安全 TCP/IP 连接" /></head><body><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">18.9. 用 SSL 进行安全的 TCP/IP 连接</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="encryption-options.html" title="18.8. 加密选项">上一页</a> </td><td width="10%" align="left"><a accesskey="u" href="runtime.html" title="第 18 章 服务器设置和操作">上一级</a></td><th width="60%" align="center">第 18 章 服务器设置和操作</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="PostgreSQL 10.1 手册">起始页</a></td><td width="10%" align="right"> <a accesskey="n" href="ssh-tunnels.html" title="18.10. 使用SSH隧道的安全 TCP/IP 连接">下一页</a></td></tr></table><hr></hr></div><div class="sect1" id="SSL-TCP"><div class="titlepage"><div><div><h2 class="title" style="clear: both">18.9. 用 SSL 进行安全的 TCP/IP 连接</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="sect2"><a href="ssl-tcp.html#SSL-CLIENT-CERTIFICATES">18.9.1. 使用客户端证书</a></span></dt><dt><span class="sect2"><a href="ssl-tcp.html#SSL-SERVER-FILES">18.9.2. SSL 服务器文件用法</a></span></dt><dt><span class="sect2"><a href="ssl-tcp.html#SSL-CERTIFICATE-CREATION">18.9.3. 创建自签名的证书</a></span></dt></dl></div><a id="idp20074576" class="indexterm"></a><p>   <span class="productname">PostgreSQL</span>有一个对使用<acronym class="acronym">SSL</acronym>连接加密客户端/服务器通讯的本地支持，它可以增加安全性。这个特性要求在客户端和服务器端都安装<span class="productname">OpenSSL</span>并且在编译<span class="productname">PostgreSQL</span>的时候打开这个支持（见<a class="xref" href="installation.html" title="第 16 章  从源代码安装">第 16 章</a>）。
  </p><p>   当<acronym class="acronym">SSL</acronym>支持被编译在<span class="productname">PostgreSQL</span>中时，可以通过将<code class="filename">postgresql.conf</code>中的 <a class="xref" href="runtime-config-connection.html#GUC-SSL">ssl</a>设置为<code class="literal">on</code>让<span class="productname">PostgreSQL</span>服务器带着<acronym class="acronym">SSL</acronym>支持被启动。 服务器在同一个 TCP 端口监听普通连接和<acronym class="acronym">SSL</acronym>连接，并且将与任何正在连接的客户端协商是否使用<acronym class="acronym">SSL</acronym>。默认情况下，这是客户端的选项，关于如何设置服务器来要求某些或者所有连接使用<acronym class="acronym">SSL</acronym>请见<a class="xref" href="auth-pg-hba-conf.html" title="20.1. pg_hba.conf文件">第 20.1 节</a>。
  </p><p>   <span class="productname">PostgreSQL</span>读取系统范围的<span class="productname">OpenSSL</span>配置文件。默认情况下，这个文件名为<code class="filename">openssl.cnf</code>并且被放置在<code class="literal">openssl version -d</code>所报告的目录中。通过设置环境变量<code class="envar">OPENSSL_CONF</code>指定你想要的配置文件名可以覆盖此默认配置。
  </p><p>   <span class="productname">OpenSSL</span>支持范围广泛的密码和认证算法。而在<span class="productname">OpenSSL</span>配置文件可以指定一个密码列表， 你可以通过在<code class="filename">postgresql.conf</code>中修改<a class="xref" href="runtime-config-connection.html#GUC-SSL-CIPHERS">ssl_ciphers</a>来指定数据库服务器使用的专用密码。
  </p><div class="note"><h3 class="title">注意</h3><p>    使用<code class="literal">NULL-SHA</code>或<code class="literal">NULL-MD5</code>可以得到身份验证但没有加密开销。不过，中间人能够读取和传递客户端和服务器之间的通信。此外，加密开销相比身份认证的开销是最小的。出于这些原因，我们建议不要使用 NULL 密码。
   </p></div><p>   要<acronym class="acronym">SSL</acronym>模式中启动服务器，包含服务器证书和私钥的文件必须存在。默认情况下，这些文件应该分别被命名为<code class="filename">server.crt</code>和<code class="filename">server.key</code>并且被放在服务器的数据目录中，但是可以通过配置参数<a class="xref" href="runtime-config-connection.html#GUC-SSL-CERT-FILE">ssl_cert_file</a>和<a class="xref" href="runtime-config-connection.html#GUC-SSL-KEY-FILE">ssl_key_file</a>指定其他名称和位置。
   </p><p>   在 Unix 系统上，<code class="filename">server.key</code>上的权限必须不允许所有人或组的任何访问，通过命令<code class="command">chmod 0600 server.key</code>可以做到。或者，该文件可以由 root 所拥有并且具有组读访问（也就是<code class="literal">0640</code>权限）。这种设置适用于由操作系统管理证书和密钥文件的安装。用于运行<span class="productname">PostgreSQL</span>服务器的用户应该被作为能够访问那些证书和密钥文件的组成员。
  </p><p>   如果私钥被一个密码保护着，服务器将提示要求这个密码，并且在它被输入前不会启动。
   使用密码还会禁用在不重启服务器的情况下更改服务器的SSL配置的功能。
   此外，密码保护的私钥在Windows上根本无法使用。
  </p><p>   在有些情况下，服务器证书可能由一个<span class="quote">“<span class="quote">中间</span>”</span>
   证书颁发机构签名，而不是直接由客户端信任的证书颁发
   机构直接签名。要使用这样的证书，请追加该签发权的证书到<code class="filename">server.crt</code>文件，然后追加其父签发权的证书，以此类推一直到一个被客户端所信任的<span class="quote">“<span class="quote">根</span>”</span>或<span class="quote">“<span class="quote">中间</span>”</span>颁发机构，即由一个位于客户端<code class="filename">root.crt</code>文件中的证书签发。
  </p><div class="sect2" id="SSL-CLIENT-CERTIFICATES"><div class="titlepage"><div><div><h3 class="title">18.9.1. 使用客户端证书</h3></div></div></div><p>   要求客户端提供受信任的证书，把你信任的证书颁发机构（<acronym class="acronym">CA</acronym>）的证书放置在数据目录的文件<code class="filename">root.crt</code>中。并且修改<code class="filename">postgresql.conf</code>中的参数<a class="xref" href="runtime-config-connection.html#GUC-SSL-CA-FILE">ssl_ca_file</a>为<code class="literal">root.crt</code>，还要把认证选项<code class="literal">clientcert=1</code>加入到<code class="filename">pg_hba.conf</code>文件中合适的<code class="literal">hostssl</code>行上。然后将在 SSL 连接启动时从客户端请求该证书（一段对于如何在客户端设置证书的描述请见<a class="xref" href="libpq-ssl.html" title="33.18. SSL 支持">第 33.18 节</a>）。服务器将验证客户端的证书是由受信任的证书颁发机构之一签名。
   </p><p>   如果中间<acronym class="acronym">CA</acronym>出现在<code class="filename">root.crt</code>中，该文件必须也包含到它们的根<acronym class="acronym">CA</acronym>的证书链。如果参数<a class="xref" href="runtime-config-connection.html#GUC-SSL-CRL-FILE">ssl_crl_file</a>被设置，证书撤销列表（CRL）项也要被检查（显示 SSL 证书用法的图标见<a class="ulink" href="http://h71000.www7.hp.com/doc/83final/ba554_90007/ch04s02.html" target="_top">http://h71000.www7.hp.com/doc/83final/ba554_90007/ch04s02.html</a>）。
  </p><p>   <code class="literal">clientcert</code>认证选项适用于所有的认证方法，但仅适用于<code class="filename">pg_hba.conf</code>中用<code class="literal">hostssl</code>指定的行。 当<code class="literal">clientcert</code>没有指定或设置为 0时，如果配置了 CA 文件，服务器将仍然会根据它验证任何提交的客户端证书 — 但是它将不会坚持要求出示一个客户端证书。
  </p><p>   请注意服务器的<code class="filename">root.crt</code>列出了顶级的 CA，它们对客户端证书的签名被认为是可信的。 原则上不需要列出签名服务器证书的 CA，然而在大多数情况下，这些 CA 对于客户端证书也是可信的。
  </p><p>   如果你在设置客户端证书，你可能希望用<code class="literal">cert</code>认证方法，这样证书控制用户认证以及提供连接安全。详见<a class="xref" href="auth-methods.html#AUTH-CERT" title="20.3.9. 证书认证">第 20.3.9 节</a>（在使用<code class="literal">cert</code>认证方法时，没有必要显式地指定<code class="literal">clientcert=1</code>）。
  </p></div><div class="sect2" id="SSL-SERVER-FILES"><div class="titlepage"><div><div><h3 class="title">18.9.2. SSL 服务器文件用法</h3></div></div></div><p>    <a class="xref" href="ssl-tcp.html#SSL-FILE-USAGE" title="表 18.2. SSL 服务器文件用法">表 18.2</a>总结了与服务器上 SSL 配置有关的文件（显示的文件名是默认的或者是经典名称。本地配置的名称可能会不同）。
   </p><div class="table" id="SSL-FILE-USAGE"><p class="title"><strong>表 18.2. SSL 服务器文件用法</strong></p><div class="table-contents"><table class="table" summary="SSL 服务器文件用法" border="1"><colgroup><col /><col /><col /></colgroup><thead><tr><th>文件</th><th>内容</th><th>效果</th></tr></thead><tbody><tr><td><a class="xref" href="runtime-config-connection.html#GUC-SSL-CERT-FILE">ssl_cert_file</a> (<code class="filename">$PGDATA/server.crt</code>)</td><td>服务器证书</td><td>发送给客户端来说明服务器的身份</td></tr><tr><td><a class="xref" href="runtime-config-connection.html#GUC-SSL-KEY-FILE">ssl_key_file</a> (<code class="filename">$PGDATA/server.key</code>)</td><td>服务器私钥</td><td>证明服务器证书是其所有者发送的，并不说明证书所有者是值得信任的</td></tr><tr><td><a class="xref" href="runtime-config-connection.html#GUC-SSL-CA-FILE">ssl_ca_file</a> (<code class="filename">$PGDATA/root.crt</code>)</td><td>可信的证书颁发机构</td><td>检查客户端证书是由一个可信的证书颁发机构签名的</td></tr><tr><td><a class="xref" href="runtime-config-connection.html#GUC-SSL-CRL-FILE">ssl_crl_file</a> (<code class="filename">$PGDATA/root.crl</code>)</td><td>被证书授权机构撤销的证书</td><td>客户端证书不能出现在这个列表上</td></tr></tbody></table></div></div><br class="table-break" /><p>    服务器在服务器启动时以及服务器配置重新加载时读取这些文件。
	在<span class="systemitem">Windows</span>系统上，只要为新客户端连接生成新的后端进程，
	它们也会重新读取。
   </p><p>    如果在服务器启动时检测到这些文件中的错误，服务器将拒绝启动。但是，
	如果在配置重新加载过程中检测到错误，则会忽略这些文件，并继续使用旧的SSL配置。
	在<span class="systemitem">Windows</span>系统上，如果在后端启动时检测到这些文件中存在错误，
	则该后端将无法建立SSL连接。在所有这些情况下，错误情况都会在服务器日志中报告。
   </p></div><div class="sect2" id="SSL-CERTIFICATE-CREATION"><div class="titlepage"><div><div><h3 class="title">18.9.3. 创建自签名的证书</h3></div></div></div><p>    要为服务器创建一个有效期为365天的快速自签名证书，
	可以使用下面的<span class="productname">OpenSSL</span>命令，
	将<em class="replaceable"><code>yourdomain.com</code></em>替换为服务器的主机名：
</p><pre class="programlisting">openssl req -new -x509 -days 365 -nodes -text -out server.crt \
  -keyout server.key -subj "/CN=<em class="replaceable"><code>yourdomain.com</code></em>"</pre><p>
    然后执行：
</p><pre class="programlisting">chmod og-rwx server.key</pre><p>
    如果文件的权限比这个更自由，服务器将拒绝该文件。要了解更多关于如何创建你的服务器私钥和证书的细节， 请参考<span class="productname">OpenSSL</span>文档。
   </p><p>    自签名的证书可以被用于测试，但由证书颁发机构（<acronym class="acronym">CA</acronym>）（要么是全局<acronym class="acronym">CA</acronym>中的一个或者一个本地 <acronym class="acronym">CA</acronym>）签名的证书应该被用在生产中，这样客户端可以验证服务器的身份。如果对于组织来说所有的客户端都是本地的，建议使用本地<acronym class="acronym">CA</acronym>。
   </p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="encryption-options.html">上一页</a> </td><td width="20%" align="center"><a accesskey="u" href="runtime.html">上一级</a></td><td width="40%" align="right"> <a accesskey="n" href="ssh-tunnels.html">下一页</a></td></tr><tr><td width="40%" align="left" valign="top">18.8. 加密选项 </td><td width="20%" align="center"><a accesskey="h" href="index.html">起始页</a></td><td width="40%" align="right" valign="top"> 18.10. 使用<span class="application">SSH</span>隧道的安全 TCP/IP 连接</td></tr></table></div></body></html>
